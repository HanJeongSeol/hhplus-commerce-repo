## 동시성 제어 방식 분석 및 Redis 분산락 도입

### 배경

이번 이커머스 시스템에서 동시성 문제가 발생할 수 있는 주요 기능은 다음과 같습니다.

- 포인트 충전 : 사용자 계정에 포인트를 충전하는 기능
- 상품 재고 감소 : 결제 시 상품 재고를 차감하는 기능
- 쿠폰 발급 : 특정 조건에 따라 쿠폰을 발급하는 기능

이 기능들은 여러 사용자가 동시에 접근했을 때 **동시성 문제**가 발생할 수 있습니다.

---

---

### 동시성 이슈 시나리오

**[발생 가능한 동시성 시나리오]**

1. 포인트 충전 시 동시성 문제
    1. 한 사용자가 동시에 포인트 충전 및 조회를 진행하면, 포인트 조회 시 충전 전 금액이 노출될 가능성이 있습니다.
    2. 동시에 두 충전 요청이 처리되면서 같은 포인트 잔액을 기준으로 잘못 업데이트 될 수 있습니다.
2. 상품 재고 감소 시 동시성 문제
    1. 다수의 사용자가 동일 상품을 동시에 구매하면, 나중 요청이 이전 요청의 재고 감소가 반영되기 전에 처리되어 초과 판매가 발생할 가능성이 있습니다.
3. 쿠폰 발급 시 동시성 문제
    1. 제한된 수량의 쿠폰에 대해 다수의 사용자가 동시에 요청하면, 초과 발급될 수 있습니다.

---

---

### 동시성 제어 방식

**[비관적 락]**

DB의 특정 행이나 테이블에 락을 설정하여 다른 트랜잭션이 해당 데이터를 변경하지 못하도록 제어합니다.
데이터 충돌 가능성이 높고, 데이터 일관성이 최우선인 경우에 사용됩니다.

1. 장점
    1. 높은 데이터 일관성
    2. 락을 사용하여 충돌 가능성 차단
2. 단점
    1. 락 설정 및 유지로 인한 DB 부하
    2. 트랜잭션의 유지 시간이 길어지면, 대기 시간이 길어져서 성능 저하 발생

---

---

**[낙관적 락]**

테이블에 버전 정보를 저장하는 필드를 활용하여 데이터 변경 시 충돌 여부를 확인할 수 있도록 합니다.
데이터 충돌 가능성이 낮다고 가정하고, 실제로 데이터를 수정할 때만 충돌을 감지하여 처리합니다.

1. 장점
    1. 실제로 DB 락을 사용하지 않으므로 DB 부하 감소
    2. 충돌이 적은 환경에서 높은 성능 제공
2. 단점
    1. 충돌이 많이 발생하는 경우 재시도가 반복되어 성능 저하 발생
    2. 트랜잭션의 재시도 로직을 별도로 구현해야 한다

---

---

**[레디스 기반 분산 락]**

Redisson 라이브러리를 활용한 Pub/Sub 기반의 분산 락, RedisTemplate를 구현하여 `SETNX`, `EXPIRE`를 활용한 동시성 제어 방식을 제공합니다.

1. 장점
    1. 메모리 기반으로 빠른 처리 속도
    2. TTL 설정을 통한 데드락 방지
    3. DB와 독립적으로 락 관리
2. 단점
    1. 락 획득 실패 시 별도의 재시도 로직 구현
    2. Redis 초기 설치 및 인프라 운영 비용
    3. 짧은 트랜잭션에서는 DB 락보다 비효율적일 수 있음

---

---

### 기능별 동시성 처리 방식

**[포인트 충전]**

- 포인트 충전은 한 사용자가 자신의 포인트에 대해 충전 요청을 수행하는 경우가 일반적이기 때문에, 포인트 충전에 대한 동시성 이슈가 발생할 가능성이 낮습니다.
- 충돌이 적은 환경이기 때문에 낙관적 락을 적용하는게 보편적이지만 비관적 락을 선택했습니다. 이유는 아래와 같습니다.
    - 단순히 개인의 포인트 충전시 발생할 수 있는 충돌이 아니라 추가 포인트 지급, 결제 실패시 포인트 회수 등 다른 기능에서도 포인트 충전 로직을 호출한다면 동시에 접근하는 트랜잭션이 많아지면서 충돌 횟수도 빈번해 질수 있다고 판단하여 비관적 락을 사용하도록 설계했었습니다.

**[선착순 쿠폰 발급]**

- 선착순 쿠폰 발급은 다수의 사용자가 동시에 쿠폰을 신청할 가능성이 매우 높기때문에, 충돌과 race condition이 자주 발생할 수 있습니다.
- 쿠폰의 수는 제한되어있기 때문에 정확한 수량 관리를 위해 비관적 락을 통해 동시 접근을 제어하여 쿠폰 발급이 정확하게 이루어지도록 했습니다.
- 비관적 락 선택 이유
    - 데이터 정확성 보장 : 제한된 수의 쿠폰을 클라이언트의 요청 순서대로 정확히 발급하는 것이 중요하고, 재고 관리가 명확해야 하기 때문에 비관적 락을 통해 중복 발급이나 초과 발급을 방지하도록 했습니다.

**[상품 재고 감소]**

- 상품의 정확한 수량 관리 및 재고보다 많은 수량의 판매를 방지할 수 있도록 정확한 동시성 제어가 필요하여 비관적 락을 사용했습니다.
- 인기 품목이나, 할인 중인 아이템인 경우에는 다수의 클라이언트가 동시에 구매를 요청할 수 있기 때문에 비관적 락을 사용하여 재고 감소가 명확히 이루어 지도록 했습니다.

---

---

### Redis 기반 분산 락 도입 이유

레디스 분산 락으로 재고 감소 및 쿠폰 발급 기능의 동시성을 처리하는 경우, DB락을 사용 할 때 보다 빠른 속도로 작업을 수행합니다.

- **데이터베이스 부하 감소**
    - 락을 활용하면 쿼리에 락을 걸기 때문에 다른 비즈니스 로직에 대한 쿼리에도 영향을 줄 수 밖에 없습니다. DB의 쿼리 부담을 줄여 락 설정 및 관리를 Redis에서 처리하여 데이터베이스의 쿼리 부담을 줄일 예정입니다.
- TTL을 통한 데드락 방지
    - TTL 설정으로 데드락 문제를 해결하도록 구현하려고 합니다.